/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Program Name: Gatherers (C)                                                                                             //
// Author: Jeffrey Bednar                                                                                                  //
// Copyright (c) Illusion Interactive, 2011 - 2025.                                                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "../Headers/card.h"
#include "../Headers/constants.h"
#include "../Headers/globals.h"
#include "../Headers/menu.h"
#include "../Headers/process.h"
#include "../Headers/Renderer/renderer.h"
#include "../Headers/timebase.h"
#include "../Headers/Windows/windows_main.h"
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl ENGINE_ProcessScene(RENDERER_T* p_Renderer,
    TIMEBASE_T* p_FrameTime,
    GLOBALS_T* p_Globals,
    ASSETS_T* p_Assets,
    CARD_T* p_Card,
    MENU_T* p_Menu,
    LOG_T* p_Log,
    SETTINGS_T* p_Settings,
    CONSTANTS_T* p_Constants) {
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Conditions determining if we will pre-process or re-render the full frame.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    UINT8 ubFullFrameRender = p_Menu->ubEnablePostProcessing |
        p_Menu->ubDrawIds |
        p_Menu->ubDrawStatistics |
        p_Menu->ubDrawResources |
        p_Menu->ubDrawStatuses |
        p_Menu->ubDrawMinorVectors |
        p_Menu->ubDrawMajorVectors;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_CaptureBorderTranslations(p_Renderer,
        p_Globals,
        p_Assets,
        p_Menu,
        p_Settings,
        p_Log);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    FDELTA_T AppliedTranslations = PROCESS_ApplyTranslations(p_Renderer,
        p_Globals,
        p_Assets);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_ResetTranslations(p_Renderer);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Re-render everything if we're panning. Otherwise, we can be selective in what we draw instead of always additive. This
    // is only worth it if diagnostics and post-processing are disabled, otherwise it gets over complicated. The same can happen 
    // in the minimap.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (ubFullFrameRender || AppliedTranslations.fDx != 0.0f || AppliedTranslations.fDy != 0.0f) {
        PROCESS_PrepareFrame(p_Renderer,
            p_Globals,
            p_Assets);
    }
    else {
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Pre-process the current frame with data from the previous frame. Not doing anything here will lead to visual artifacts
        // that will help identify zones in the frame that need to be redrawn.
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        PROCESS_HandlePreProcessing(p_Renderer,
            p_Menu,
            p_Assets,
            p_Globals,
            p_Log);
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Process and pass through to the renderer.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_UpdateAnimations(p_Globals);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_ProcessEntities(p_Renderer,
        p_Globals,
        p_Assets,
        p_Menu,
        p_Log,
        p_Settings);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_DrawSelectionArea(p_Renderer,
        p_Globals,
        p_Assets);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_DrawBuildType(p_Renderer,
        p_Globals,
        p_Assets,
        p_Menu,
        p_Log);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_ProcessMessages(p_Renderer,
        p_Globals,
        p_Assets,
        p_Menu,
        p_Constants,
        p_Log);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CARD_EvaluateSelected(p_Card,
        p_Globals,
        p_Assets);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_HandleHud(p_Renderer,
        p_Globals,
        p_Assets,
        p_Card,
        p_Menu,
        p_Settings,
        p_Log);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PROCESS_HandleDiagnostics(p_Renderer,
        p_Globals,
        p_Assets,
        p_Menu,
        p_Settings);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Renderer->HandlePostProcessing(p_Renderer,
        p_Menu,
        p_Globals,
        p_Log);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Renderer->PresentFrame(p_Renderer);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->fEngineTime = TIMEBASE_EndTimer(p_FrameTime);
    p_Globals->fEngineTimeSum += p_Globals->fEngineTime;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    TIMEBASE_ResetTimer(p_FrameTime);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
