/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Program Name: Gatherers (C)                                                                                             //
// Author: Jeffrey Bednar                                                                                                  //
// Copyright (c) Illusion Interactive, 2011 - 2025.                                                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "../Headers/globals.h"
#include "../Headers/heap_allocator.h"
#include "../Headers/log.h"
#include "../Headers/misc.h"
#include <stdint.h>
#include <stdlib.h>
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl HEAP_ALLOCATOR_Zero(HEAP_ALLOCATOR_T* p_Allocator) {
    ZeroMemory(p_Allocator, sizeof(HEAP_ALLOCATOR_T));
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl HEAP_ALLOCATOR_ZeroBlock(void* vp_Block, size_t stBlockSizeAligned) {
    ZeroMemory(vp_Block, stBlockSizeAligned);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
HEAP_ALLOCATOR_T* __cdecl HEAP_ALLOCATOR_Create(size_t stBlockSize, size_t stCapacity, GLOBALS_T* p_Globals, LOG_T* p_Log) {
    if (stCapacity == 0 || stBlockSize == 0) {
        MISC_WriteOut(p_Log, LOG_SEVERITY_FATAL, "HEAP_ALLOCATOR_Create(): Invalid block size or capacity\n");
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    size_t stAllocation = sizeof(HEAP_ALLOCATOR_T);
    HEAP_ALLOCATOR_T* p_Allocator = malloc(stAllocation);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (!p_Allocator) {
        MISC_WriteOutParams(p_Log, LOG_SEVERITY_FATAL, "HEAP_ALLOCATOR_Create(): Malloc failed for size: %zu bytes\n", stAllocation);
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HEAP_ALLOCATOR_Zero(p_Allocator);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->stAllocations += stAllocation;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Round to the nearest multiple of void*.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    size_t stBlockAligned = (stBlockSize + sizeof(void*) - 1) & ~(sizeof(void*) - 1);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    size_t stTotalBlockSizeAligned = stBlockAligned * stCapacity;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Allocator->stBlockSizeRequested = stBlockSize;
    p_Allocator->stBlockSizeAligned = stBlockAligned;
    p_Allocator->stTotalBlockSizeAligned = stTotalBlockSizeAligned;
    p_Allocator->stCapacity = stCapacity;
    p_Allocator->vp_Block = malloc(stTotalBlockSizeAligned);
    p_Allocator->p_FreeList = NULL;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (!p_Allocator->vp_Block) {
        free(p_Allocator);
        MISC_WriteOutParams(p_Log, LOG_SEVERITY_FATAL, "HEAP_ALLOCATOR_Create(): Total block malloc failed for aligned size: %zu bytes\n", stTotalBlockSizeAligned);
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HEAP_ALLOCATOR_ZeroBlock(p_Allocator->vp_Block, stTotalBlockSizeAligned);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->stAllocations += p_Allocator->stTotalBlockSizeAligned;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    size_t stI;
    uint8_t* p_ubIncrement = (uint8_t*)p_Allocator->vp_Block;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    for (stI = 0; stI < stCapacity; stI++) {
        HEAP_ALLOCATOR_NODE_T* p_AllocatorNode = (HEAP_ALLOCATOR_NODE_T*)p_ubIncrement;
        p_AllocatorNode->p_Next = p_Allocator->p_FreeList;
        p_Allocator->p_FreeList = p_AllocatorNode;
        p_ubIncrement += stBlockAligned;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HEAP_ALLOCATOR_TrackNodes(p_Allocator);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    return p_Allocator;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void* __cdecl HEAP_ALLOCATOR_Alloc(HEAP_ALLOCATOR_T* p_Allocator, LOG_T* p_Log) {
    if (!p_Allocator) {
        MISC_WriteOut(p_Log, LOG_SEVERITY_FATAL, "HEAP_ALLOCATOR_Alloc(): Allocator is NULL.\n");
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (!p_Allocator->p_FreeList) {
        MISC_WriteOut(p_Log, LOG_SEVERITY_FATAL, "HEAP_ALLOCATOR_Alloc(): Allocator out of memory.\n");
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HEAP_ALLOCATOR_NODE_T* vp_Node = p_Allocator->p_FreeList;
    p_Allocator->p_FreeList = vp_Node->p_Next;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ZeroMemory(vp_Node, p_Allocator->stBlockSizeAligned);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ++p_Allocator->stAllocCount;
    HEAP_ALLOCATOR_TrackNodes(p_Allocator);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (p_Allocator->stAllocCount > p_Allocator->stPeakAllocCount) {
        p_Allocator->stPeakAllocCount = p_Allocator->stAllocCount;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    return (void*)vp_Node;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl HEAP_ALLOCATOR_Free(HEAP_ALLOCATOR_T* p_Allocator, void* vp_Block, LOG_T* p_Log) {
    if (!p_Allocator || !vp_Block) {
        MISC_WriteOut(p_Log, LOG_SEVERITY_ERROR, "HEAP_ALLOCATOR_Free(): Allocator or block not initialized.\n");
        return;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HEAP_ALLOCATOR_NODE_T* p_Node = (HEAP_ALLOCATOR_NODE_T*)vp_Block;
    p_Node->p_Next = p_Allocator->p_FreeList;
    p_Allocator->p_FreeList = p_Node;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    --p_Allocator->stAllocCount;
    HEAP_ALLOCATOR_TrackNodes(p_Allocator);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl HEAP_ALLOCATOR_TrackNodes(HEAP_ALLOCATOR_T* p_Allocator) {
    p_Allocator->stFreeCount = p_Allocator->stCapacity - p_Allocator->stAllocCount;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl HEAP_ALLOCATOR_Kill(HEAP_ALLOCATOR_T** pp_Allocator, GLOBALS_T* p_Globals) {
    HEAP_ALLOCATOR_T* p_Allocator = *pp_Allocator;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (p_Allocator) {
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        free(p_Allocator->vp_Block);
        p_Globals->stAllocations -= p_Allocator->stTotalBlockSizeAligned;
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        free(p_Allocator);
        p_Globals->stAllocations -= sizeof(HEAP_ALLOCATOR_T);
        *pp_Allocator = NULL;
    }
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
