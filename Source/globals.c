/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Program Name: Gatherers (C)                                                                                             //
// Author: Jeffrey Bednar                                                                                                  //
// Copyright (c) Illusion Interactive, 2011 - 2025.                                                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "../Headers/globals.h"
#include "../Headers/misc.h"
#include "../Headers/settings.h"
#include <stdio.h>
#include <stdlib.h>
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl GLOBALS_Zero(GLOBALS_T* p_Globals) {
    ZeroMemory(p_Globals, sizeof(GLOBALS_T));
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// This is the root instantiation, so log will likely not be initialized. Here for consistency.
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
GLOBALS_T* __cdecl GLOBALS_Create(LOG_T* p_Log) {
    size_t stAllocation = sizeof(GLOBALS_T);
    GLOBALS_T* p_Globals = malloc(stAllocation);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (!p_Globals) {
        MISC_WriteOutParams(p_Log, LOG_SEVERITY_FATAL, "GLOBALS_Create(): Malloc failed for size: %zu bytes\n", stAllocation);
        return NULL;
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    GLOBALS_Zero(p_Globals);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->stAllocations += stAllocation;
    return p_Globals;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
size_t __cdecl GLOBALS_Kill(GLOBALS_T** pp_Globals) {
    GLOBALS_T* p_Globals = *pp_Globals;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    size_t stAllocationsRemaning = p_Globals->stAllocations;
    free(p_Globals);
    stAllocationsRemaning -= sizeof(GLOBALS_T);
    *pp_Globals = NULL;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    return stAllocationsRemaning;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Settings that only need to be calculated once or I would like toggled on at run-time.
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl GLOBALS_Init(GLOBALS_T* p_Globals, HINSTANCE hInstance, SETTINGS_T* p_Settings) {
    p_Globals->usIdStamp = 1;
    p_Globals->usThreshold = 15;
    p_Globals->iMineralCount = 10000;
    p_Globals->iGasCount = 10000;
    p_Globals->iTotalSupply = 10;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->usMapIndex = 0;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // The modules instance needs to be captured incase resources are loaded directly from the executable.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Globals->hInstance = hInstance;
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Animation engine is based of the processing speed.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    GLOBALS_ApplyAnimationRate(p_Globals, p_Settings);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl GLOBALS_ApplyAnimationRate(GLOBALS_T* p_Globals, SETTINGS_T* p_Settings) {
    p_Globals->fAnimationTick = 1000.0f * (1.0f / p_Settings->fAnimateFPS) * p_Settings->fEngineFPS / 1000.0f;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl GLOBALS_ReceiveHotReload(SETTINGS_T* p_Settings, GLOBALS_T* p_Globals) {
    GLOBALS_ApplyAnimationRate(p_Globals, p_Settings);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
