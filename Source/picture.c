/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Program Name: Gatherers (C)                                                                                             //
// Author: Jeffrey Bednar                                                                                                  //
// Copyright (c) Illusion Interactive, 2011 - 2025.                                                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "../Headers/log.h"
#include "../Headers/misc.h"
#include "../Headers/picture.h"
#include "../Headers/Windows/windows_minified.h"
#include <stdio.h>
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl PICTURE_Zero(PICTURE_T* p_Picture) {
    ZeroMemory(p_Picture, sizeof(PICTURE_T));
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl PICTURE_Load(PICTURE_T* p_Picture, FPOINT_T Location, char* p_szFileName, char* p_szFileNameMask, LOG_T* p_Log) {
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PICTURE_Zero(p_Picture);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Picture->hBmp = LoadImage(NULL, p_szFileName, IMAGE_BITMAP, 0, 0, LR_LOADFROMFILE);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (!p_Picture->hBmp) {
        MISC_WriteOutParams(p_Log, LOG_SEVERITY_ERROR, "PICTURE_Load(): Picture file not found (%s).\n", p_szFileName);
    }
    else {
        GetObject(p_Picture->hBmp, sizeof(BITMAP), &p_Picture->Bitmap);
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (p_szFileNameMask) {
        p_Picture->hBmpMask = LoadImage(NULL, p_szFileNameMask, IMAGE_BITMAP, 0, 0, LR_LOADFROMFILE);
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        if (!p_Picture->hBmpMask) {
            MISC_WriteOutParams(p_Log, LOG_SEVERITY_ERROR, "PICTURE_Load(): Mask file not found (%s).\n", p_szFileNameMask);
        }
        else {
            GetObject(p_Picture->hBmpMask, sizeof(BITMAP), &p_Picture->BitmapMask);
        }
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Picture->Location = Location;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl PICTURE_Scale(PICTURE_T* p_Original, PICTURE_T* p_Scaled, HWND hWnd, FDELTA_T NewSize, LOG_T* p_Log) {
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    PICTURE_Zero(p_Scaled);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Temporary compatible DC's to the main window.
     ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HDC hDC = GetDC(hWnd);
    HDC hdcSource = CreateCompatibleDC(hDC);
    HDC hdcDestination = CreateCompatibleDC(hDC);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Main image.
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    HGDIOBJ hMainSource = SelectObject(hdcSource, p_Original->hBmp);
    p_Scaled->hBmp = CreateCompatibleBitmap(hDC, NewSize.fDx, NewSize.fDy);
    HGDIOBJ hMainDestination = SelectObject(hdcDestination, p_Scaled->hBmp);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Blend pixels instead of dropping them (COLORONCOLOR).
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    SetStretchBltMode(hdcDestination, HALFTONE);
    SetBrushOrgEx(hdcDestination, 0, 0, NULL);
    StretchBlt(hdcDestination,
        0,
        0,
        NewSize.fDx,
        NewSize.fDy,
        hdcSource,
        0,
        0,
        p_Original->Bitmap.bmWidth,
        p_Original->Bitmap.bmHeight,
        SRCCOPY
    );
    GetObject(p_Scaled->hBmp, sizeof(BITMAP), &p_Scaled->Bitmap);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    SelectObject(hdcSource, hMainSource);
    SelectObject(hdcDestination, hMainDestination);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Mask
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    if (p_Original->hBmpMask) {
        HGDIOBJ hMaskSource = SelectObject(hdcSource, p_Original->hBmpMask);
        p_Scaled->hBmpMask = CreateCompatibleBitmap(hDC, NewSize.fDx, NewSize.fDy);
        HGDIOBJ hMaskDestination = SelectObject(hdcDestination, p_Scaled->hBmpMask);
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        SetStretchBltMode(hdcDestination, BLACKONWHITE);
        StretchBlt(hdcDestination,
            0,
            0,
            NewSize.fDx,
            NewSize.fDy,
            hdcSource,
            0,
            0,
            p_Original->BitmapMask.bmWidth,
            p_Original->BitmapMask.bmHeight,
            SRCCOPY
        );
        GetObject(p_Scaled->hBmpMask, sizeof(BITMAP), &p_Scaled->BitmapMask);
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        SelectObject(hdcSource, hMaskSource);
        SelectObject(hdcDestination, hMaskDestination);
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    DeleteDC(hdcSource);
    DeleteDC(hdcDestination);
    ReleaseDC(hWnd, hDC);
    /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    p_Scaled->Location = p_Original->Location;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl PICTURE_Kill(PICTURE_T* p_Picture) {
    if (p_Picture) {
        if (p_Picture->hBmp) {
            DeleteObject(p_Picture->hBmp);
        }
        if (p_Picture->hBmpMask) {
            DeleteObject(p_Picture->hBmpMask);
        }
    }
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
