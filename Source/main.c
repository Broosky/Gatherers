/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Program Name: Gatherers (C)                                                                                             //
// Author: Jeffrey Bednar                                                                                                  //
// Copyright (c) Illusion Interactive, 2011 - 2025.                                                                        //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Development notes:
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// - Windows XP does not like the progress bar control created by WinAsm studio. I replaced it with a general label system.
// - Put simple variables that are accessed via dereferencing onto the stack.
// - I no longer use the original taskbar image. Remove it from the loading process.
// - When the process terminates, the operating system will destroy the image objects automatically.
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifndef _MAIN_C_
#define _MAIN_C_
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "../Headers/constants.h"
#include "../Headers/functions.h"
#include "../Headers/main.h"
#include "../Headers/types.h"
#include <stdlib.h>
#include <windows.h>
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Define externs.
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
GLOBALS* p_Globals = NULL;
MENU* p_Menu = NULL;
LOG* p_Log = NULL;
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
int WINAPI WinMain(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ int nCmdShow) {
#if DEBUG
	// Ensure the console is available with Visual Studio (Linker: /SUBSYSTEM:WINDOWS).
	MAIN_LaunchConsole();
#endif
	char szCurrentWorkingDirectory[MAX_PATH];
	if (GetCurrentDirectory(MAX_PATH, szCurrentWorkingDirectory)) {
		printf("Current working directory: %s\n", szCurrentWorkingDirectory);
	}
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	p_Globals = (GLOBALS*)GLOBALS_Create();
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// Special case fail-fast for the log system.
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	p_Log = (LOG*)LOG_Create("Gatherers.log", p_Globals);
	if (!p_Log) {
		// Unable to create the log file.
		LOG_Kill(p_Log, p_Globals);
		MAIN_Kill(p_Globals);
		TerminateProcess(GetCurrentProcess(), EXIT_FAILURE);
	}
	LOG_Append(p_Log, "File hook successful...");
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	p_Settings = (SETTINGS*)SETTINGS_Create(p_Globals);
	p_Images = (IMAGES*)IMAGES_Create(p_Globals);
	p_Menu = (MENU*)MENU_Create(p_Globals);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	SetConsoleTitle(APP_NAME);
	srand(GetTickCount64());
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	WNDCLASSEX WndClassEx;
	ZeroMemory(&WndClassEx, sizeof(WNDCLASSEX));
	WndClassEx.cbSize = sizeof(WNDCLASSEX);
	WndClassEx.style = 0;
	WndClassEx.lpfnWndProc = WINPROC_WindowProc;
	WndClassEx.cbClsExtra = 0;
	WndClassEx.cbWndExtra = 0;
	WndClassEx.hInstance = hInstance;
	WndClassEx.hIcon = LoadIcon(hInstance, MAKEINTRESOURCE(ICO_MAIN));
	WndClassEx.hIconSm = WndClassEx.hIcon;
	WndClassEx.hCursor = LoadCursor(NULL, MAKEINTRESOURCE(IDC_CROSS));
	WndClassEx.hbrBackground = CreateSolidBrush(RGB(100, 100, 100));
	WndClassEx.lpszMenuName = NULL;
	WndClassEx.lpszClassName = APP_NAME;
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	RegisterClassEx(&WndClassEx);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	DialogBoxParam(hInstance, MAKEINTRESOURCE(DLG_LOAD), NULL, WINPROC_DlgLoad, (LPARAM)WndClassEx.hIcon);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	p_Menu->hMenu = LoadMenu(hInstance, MAKEINTRESOURCE(MAIN_MENU));
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	GLOBALS_Init(p_Globals, hInstance);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	MENU_Init(p_Menu);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	HWND hWnd = CreateWindowEx(
		0,
		APP_NAME,
		APP_NAME,
		WS_OVERLAPPEDWINDOW,
		100,
		100,
		600,
		400,
		NULL,
		p_Menu->hMenu,
		hInstance,
		NULL
	);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	MISC_ResizeWindow(hWnd, INITIAL_CLIENT_WIDTH, INITIAL_CLIENT_HEIGHT);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	p_DblBuf = DBLBUF_Create(hWnd, p_Globals);
	DBLBUF_SetBlitter(p_DblBuf, &p_Images->Blitter[0]);
	DBLBUF_Clear(p_DblBuf, RGB(0, 0, 0));
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	ShowWindow(hWnd, nCmdShow);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	TIMEBASE* p_Engine = (TIMEBASE*)TIMEBASE_Create(ENGINE_FPS, p_Globals);
	TIMEBASE* p_Seconds = (TIMEBASE*)TIMEBASE_Create(1.0f, p_Globals);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	RENDER_Init(p_DblBuf);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	CARD* p_Card = (CARD*)CARD_Create(p_Globals, p_Images);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	MSG Msg;
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	while (1) {
		if (PeekMessage(&Msg, hWnd, 0, 0, PM_REMOVE)) {
			if (Msg.message == WM_QUIT) {
				MAIN_HandleQuit(p_DblBuf, p_Engine, p_Seconds, p_Card, hWnd, p_Globals, p_Images, p_Menu, p_Settings, p_Log);
				break;
			}
			else {
				TranslateMessage(&Msg);
				DispatchMessage(&Msg);
				/////////////////////////////////////////////////////////////////////////////////////////////////////////////
				MAIN_ConsiderEngine(p_Engine, p_Seconds, p_Card, p_DblBuf, p_Globals, p_Images, p_Menu);
			}
		}
		else {
			MAIN_ConsiderEngine(p_Engine, p_Seconds, p_Card, p_DblBuf, p_Globals, p_Images, p_Menu);
		}
	}
	return Msg.wParam;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl MAIN_ConsiderEngine(TIMEBASE* p_Engine, TIMEBASE* p_Seconds, CARD* p_Card, DBLBUF* p_DblBuf, GLOBALS* p_Globals, IMAGES* p_Images, MENU* p_Menu) {
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	if (TIMEBASE_Tick(p_Engine)) {
		ENGINE_ProcessScene(p_DblBuf, p_Globals, p_Images, p_Card, p_Menu);
	}
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	if (TIMEBASE_Tick(p_Seconds)) {
		p_Globals->ulSecondsTick++;
		p_Globals->fFramesPerSecond = (float)p_Globals->ulFrameCount / p_Globals->ulSecondsTick;
		p_Globals->fEngineTimeAverage = p_Globals->fEngineTimeSum * 1000.0f / p_Globals->ulSecondsTick;
	}
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl MAIN_HandleQuit(DBLBUF* p_DblBuf, TIMEBASE* p_Engine, TIMEBASE* p_Seconds, CARD* p_Card, HWND hWnd, GLOBALS* p_Globals, IMAGES* p_Images, MENU* p_Menu, SETTINGS* p_Settings, LOG* p_Log) {
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// Destroy everything the program uses.
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	ENTITY_DeleteAll(p_Globals);
	MESSAGE_DeleteAll(p_Globals);
	DBLBUF_Kill(p_DblBuf, p_Globals);
	IMAGES_Kill(p_Images, p_Globals);
	TIMEBASE_Kill(p_Engine, p_Globals);
	TIMEBASE_Kill(p_Seconds, p_Globals);
	CARD_Kill(p_Card, p_Globals);
	SETTINGS_Kill(p_Settings, p_Globals);
	MENU_Kill(p_Menu, p_Globals);
	LOG_Kill(p_Log, p_Globals);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	DestroyMenu(p_Menu->hMenu);
	DestroyWindow(hWnd);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	MAIN_Kill(p_Globals);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl MAIN_Kill(GLOBALS* p_Globals) {
	int iRemainingHeap = GLOBALS_Kill(p_Globals);
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	if (iRemainingHeap) {
		printf("Warning: Remaining heap does not equal zero (%d Bytes).\n", iRemainingHeap);
	}
	else {
		printf("Heap successfully freed.\n");
	}
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	Sleep(1750);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void __cdecl MAIN_LaunchConsole(void) {
	AllocConsole();
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	FILE* p_File;
	freopen_s(&p_File, "CONOUT$", "w", stdout);
	freopen_s(&p_File, "CONOUT$", "w", stderr);
	freopen_s(&p_File, "CONIN$", "r", stdin);
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#endif
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
